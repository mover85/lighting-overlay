var e=require("twitter-api-v2"),t=require("queue"),i=require("twemoji"),s=require("@wordpress/autop");function a(e){return e&&e.__esModule?e.default:e}var r;let n;r={get:()=>n,set(e){n=e}};class o{constructor(e){this.stream=null,this.nodecg=e,this.twitter=null,this.durationTimer=!1,this.currentCallback=null,this.streamPaused=e.Replicant("streamPaused",{defaultValue:!0,persistent:!1}),this.streamConnected=e.Replicant("streamConnected",{defaultValue:!1,persistent:!1}),this.tweetShowing=e.Replicant("tweetShowing",{defaultValue:!1,persistent:!1}),this.tweetHold=e.Replicant("tweetHold",{defaultValue:!1,persistent:!1}),this.tweetDuration=e.Replicant("tweetDuration",{defaultValue:10,persistent:!0}),this.tweet=e.Replicant("tweet",{defaultValue:{}}),this.queue=a(t)({concurrency:1,autostart:!0}),this.login().then((()=>this.setRules())).catch((t=>e.log.error(t)))}handleError(t){if(t.type===e.ETwitterApiError.Request)throw new Error("Request failed. "+t.requestError);if(t.type===e.ETwitterApiError.Response)throw new Error("Twitter didn't accept your request. HTTP code: "+t.code)}async login(){const t=new e.TwitterApi({appKey:this.nodecg.bundleConfig.twitter.consumerKey,appSecret:this.nodecg.bundleConfig.twitter.consumerSecret});try{this.twitter=await t.appLogin()}catch(e){this.handleError(e)}}async setRules(){if(!this.twitter)throw new Error("Twitter API not initialized.");try{const e=await this.twitter.v2.streamRules();e.data?.length&&await this.twitter.v2.updateStreamRules({delete:{ids:e.data.map((e=>e.id))}})}catch(e){this.handleError(e)}try{await this.twitter.v2.updateStreamRules({add:[{value:"cat has:media",tag:"cats with media"}]})}catch(e){this.handleError(e)}}async start(){if(!this.streamConnected.value){if(!this.twitter)throw new Error("Twitter API not initialized.");try{this.stream=await this.twitter.v2.searchStream({"tweet.fields":["author_id","text","id","created_at","entities"],"user.fields":["name","username","profile_image_url"],"media.fields":["type","url","preview_image_url"],expansions:["attachments.media_keys","author_id"]}),this.stream.autoReconnect=!0,this.nodecg.log.info("Connection has been opened."),this.streamPaused.value=!1,this.streamConnected.value=!0,this.queue.start(),this.listen()}catch(e){this.handleError(e)}}}listen(){if(!this.stream)throw new Error("Twitter Stream not initialized.");this.nodecg.log.info("Listening for tweets."),this.stream.on(e.ETwitterStreamEvent.ConnectionError,(e=>{this.streamConnected.value=!1,this.nodecg.log.error("Connection error!",e)})),this.stream.on(e.ETwitterStreamEvent.ConnectionClosed,(()=>{this.streamConnected.value=!1,this.nodecg.log.info("Connection has been closed.")})),this.stream.on(e.ETwitterStreamEvent.Data,(e=>{if(this.queue.length>20)return;const t=this.processMessage(e);this.queue.push((e=>{this.showTweet(t,e)}))})),this.stream.on(e.ETwitterStreamEvent.DataKeepAlive,(()=>this.nodecg.log.info("Twitter has sent a keep-alive packet.")))}stop(){this.streamConnected.value&&this.stream.close()}pause(){this.streamPaused.value||this.tweetHold.value||(this.nodecg.log.info("Queue has been paused."),this.streamPaused.value=!0,this.queue.stop())}resume(){this.streamPaused.value&&!this.tweetHold.value&&(this.nodecg.log.info("Queue has been resumed."),this.streamPaused.value=!1,this.queue.start())}showTweet(e,t){this.tweetShowing.value||(this.currentCallback=t,this.tweet.value=e,this.tweetShowing.value=!0,this.tweetHold.value||this.hideTweet())}hideTweet(){if(this.tweetShowing.value)return this.tweetHold.value?(this.tweetShowing.value=!1,void setTimeout((()=>{this.currentCallback()}),3e3)):void(this.durationTimer=setTimeout((()=>{this.tweetShowing.value=!1,setTimeout((()=>{this.currentCallback()}),3e3)}),1e3*this.tweetDuration.value))}toggle(e){this.tweetHold.value!==e&&(e?(this.nodecg.log.info("Tweet is now on hold."),this.tweetShowing.value&&this.durationTimer&&(clearTimeout(this.durationTimer),this.durationTimer=!1)):(this.nodecg.log.info("Tweet is now not on hold."),this.hideTweet()),this.tweetHold.value=e)}processMessage(e){let t=e.data.text,r={};e.includes.users.forEach((t=>{t.id===e.data.author_id&&(r=t)}));const n={avatarUrl:r.profile_image_url,name:r.username,screenName:r.name,createdAt:e.data.created_at,id:e.data.id};e.data.entities?.mentions?.reverse().forEach((e=>{const i=e.start,s=e.end;t=t.substring(0,i)+`<span class="link">${t.substring(i,s+1)}</span>`+t.substring(s+1)})),t=a(i).parse(t),e.data.entities?.urls?.forEach((e=>{t=t.split(e.url).join(`<span class="link">${e.display_url}</span>`)})),e.data.entities?.hashtags?.sort(((e,t)=>t.tag.length-e.tag.length)).forEach((e=>{t="millarstlights"===e.tag.toLowerCase()?t.split(`#${e.tag}`).join(`<span class="link purple">#${e.tag}</span>`):t.split(`#${e.tag}`).join(`<span class="link">#${e.tag}</span>`)}));const o=[];return e.includes.media?.forEach((e=>{"photo"===e.type?(o.push(e.url+":large"),t=t.split(e.url).join("")):t=t.split(e.url).join(`<span class="link">${e.url}</span>`)})),n.images=o,n.body=s.autop(t),n}}var l=e=>{const t=e.Replicant("nowPlayingPaused",{defaultValue:!1,persistent:!1}),i=e.Replicant("nowPlayingShowing",{defaultValue:!1,persistent:!1}),s=e.Replicant("nowPlaying",{defaultValue:{},persistent:!1}),a=e.Replicant("assets:albumart",{defaultValue:[],persistent:!1});let r;e.listenFor("toggleNowPlaying",(e=>{t.value!==e&&(t.value=e)})),e.listenFor("nowPlaying",(e=>{const n=a.value.filter((t=>t.name===e.album.toLowerCase().replace(" ","_")));let o="";n.length&&(o=n[0].url),s.value={...e,artUrl:o},i.value&&(clearTimeout(r),i.value=!1),i.value||t.value||(i.value=!0,r=setTimeout((()=>{i.value=!1}),12e3))}))};module.exports=e=>{a(r).set(e),l(e),function(e){if(!e.bundleConfig||void 0===e.bundleConfig.twitter)return void e.log.error(`"twitter" is not defined in cfg/${e.bundleName}.json! This object contains other properties that are required for the Twitter graphic to function.`);const t=new o(e);e.listenFor("startTweetStream",(()=>t.start())),e.listenFor("stopTweetStream",(()=>t.stop())),e.listenFor("pauseTweetStream",(()=>t.pause())),e.listenFor("resumeTweetStream",(()=>t.resume())),e.listenFor("holdTweetToggle",(e=>t.toggle(e)))}(e)};
//# sourceMappingURL=index.js.map
