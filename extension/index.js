!function(e,t,i,r,n){var a="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},s="function"==typeof a.parcelRequire5971&&a.parcelRequire5971,o=s.cache||{},l="undefined"!=typeof module&&"function"==typeof module.require&&module.require.bind(module);function u(t,i){if(!o[t]){if(!e[t]){var r="function"==typeof a.parcelRequire5971&&a.parcelRequire5971;if(!i&&r)return r(t,!0);if(s)return s(t,!0);if(l&&"string"==typeof t)return l(t);var n=new Error("Cannot find module '"+t+"'");throw n.code="MODULE_NOT_FOUND",n}c.resolve=function(i){var r=e[t][1][i];return null!=r?r:i},c.cache={};var d=o[t]=new u.Module(t);e[t][0].call(d.exports,c,d,d.exports,this)}return o[t].exports;function c(e){var t=c.resolve(e);return!1===t?{}:u(t)}}u.isParcelRequire=!0,u.Module=function(e){this.id=e,this.bundle=u,this.exports={}},u.modules=e,u.cache=o,u.parent=s,u.register=function(t,i){e[t]=[function(e,t){t.exports=i},{}]},Object.defineProperty(u,"root",{get:function(){return a.parcelRequire5971}}),a.parcelRequire5971=u;for(var d=0;d<t.length;d++)u(t[d]);var c=u(i);"object"==typeof exports&&"undefined"!=typeof module?module.exports=c:"function"==typeof define&&define.amd&&define((function(){return c}))}({"2yoZy":[function(e,t,i){var r=e("@parcel/transformer-js/src/esmodule-helpers.js");r.defineInteropFlag(i);var n=e("./util/nodecg-api-context"),a=r.interopDefault(n),s=e("./twitter"),o=r.interopDefault(s),l=e("./nowplaying"),u=r.interopDefault(l);i.default=e=>{a.default.set(e),(0,u.default)(e),(0,o.default)(e)}},{"./util/nodecg-api-context":"fBgQh","./twitter":"hVVkm","./nowplaying":"1VBCz","@parcel/transformer-js/src/esmodule-helpers.js":"di8yw"}],fBgQh:[function(e,t,i){"use strict";let r;t.exports={get:()=>r,set(e){r=e}}},{}],hVVkm:[function(e,t,i){var r=e("@parcel/transformer-js/src/esmodule-helpers.js");r.defineInteropFlag(i);var n=e("twitter-api-v2"),a=e("queue"),s=r.interopDefault(a),o=e("twemoji"),l=r.interopDefault(o),u=e("@wordpress/autop"),d=e("leo-profanity");const c=e=>{if(e.type===n.ETwitterApiError.Request)throw new Error(`Request failed. ${e.requestError}`);if(e.type===n.ETwitterApiError.Response)throw new Error(`Twitter didn't accept your request. HTTP code: ${e.code}`)};class h{constructor(e){this.stream=null,this.nodecg=e,this.twitter=null,this.durationTimer=!1,this.currentCallback=null,this.debug=!1,this.streamPaused=e.Replicant("streamPaused",{defaultValue:!0,persistent:!1}),this.streamConnected=e.Replicant("streamConnected",{defaultValue:!1,persistent:!1}),this.tweetShowing=e.Replicant("tweetShowing",{defaultValue:!1,persistent:!1}),this.tweetHold=e.Replicant("tweetHold",{defaultValue:!1,persistent:!1}),this.tweetDuration=e.Replicant("tweetDuration",{defaultValue:10,persistent:!0}),this.tweet=e.Replicant("tweet",{defaultValue:{avatarUrl:"",name:"",screenName:"",createdAt:null,id:null,images:[]}}),!0===this.nodecg.bundleConfig.twitter?.debug&&(this.nodecg.log.info(`${this.nodecg.bundleName} is in debug mode, using hashtag #cat`),this.debug=!0),this.queue=(0,s.default)({concurrency:1,autostart:!0}),this.login().then((()=>this.setRules())).catch((t=>e.log.error(t)))}async login(){const e=new(0,n.TwitterApi)({appKey:this.nodecg.bundleConfig.twitter.consumerKey,appSecret:this.nodecg.bundleConfig.twitter.consumerSecret});try{this.twitter=await e.appLogin()}catch(e){c(e)}}async setRules(){if(!this.twitter)throw new Error("Twitter API not initialized.");try{const e=await this.twitter.v2.streamRules();e.data?.length&&await this.twitter.v2.updateStreamRules({delete:{ids:e.data.map((e=>e.id))}})}catch(e){c(e)}try{await this.twitter.v2.updateStreamRules({add:[{value:this.debug?"#cat":"#millarstlights",tag:"lighting hashtag"}]})}catch(e){c(e)}}async start(){if(!this.streamConnected.value){if(!this.twitter)throw new Error("Twitter API not initialized.");try{this.stream=await this.twitter.v2.searchStream({"tweet.fields":["author_id","text","id","created_at","entities"],"user.fields":["name","username","profile_image_url"],"media.fields":["type","url","preview_image_url"],expansions:["attachments.media_keys","author_id"]}),this.stream.autoReconnect=!0,this.nodecg.log.info("Connection has been opened."),this.streamPaused.value=!1,this.streamConnected.value=!0,this.queue.start(),this.listen()}catch(e){c(e)}}}listen(){if(!this.stream)throw new Error("Twitter Stream not initialized.");this.nodecg.log.info("Listening for tweets."),this.stream.on(n.ETwitterStreamEvent.ConnectionError,(e=>{this.streamConnected.value=!1,this.nodecg.log.error("Connection error!",e)})),this.stream.on(n.ETwitterStreamEvent.ConnectionClosed,(()=>{this.streamConnected.value=!1,this.nodecg.log.info("Connection has been closed.")})),this.stream.on(n.ETwitterStreamEvent.Data,(e=>{this.queue.length>20?this.nodecg.log.debug("Tweet queue limit exceeded."):(this.nodecg.log.debug("Tweet received."),this.processMessage(e))})),this.stream.on(n.ETwitterStreamEvent.DataKeepAlive,(()=>this.nodecg.log.info("Twitter has sent a keep-alive packet.")))}stop(){this.streamConnected.value&&this.stream.close()}pause(){this.streamPaused.value||this.tweetHold.value||(this.nodecg.log.info("Queue has been paused."),this.streamPaused.value=!0,this.queue.stop())}resume(){this.streamPaused.value&&!this.tweetHold.value&&(this.nodecg.log.info("Queue has been resumed."),this.streamPaused.value=!1,this.queue.start())}showTweet(e,t){this.tweetShowing.value||(this.currentCallback=t,this.tweet.value=e,this.tweetShowing.value=!0,this.tweetHold.value||this.hideTweet())}hideTweet(){if(this.tweetShowing.value)return this.tweetHold.value?(this.tweetShowing.value=!1,void setTimeout((()=>{this.currentCallback()}),3e3)):void(this.durationTimer=setTimeout((()=>{this.tweetShowing.value=!1,setTimeout((()=>{this.currentCallback()}),3e3)}),1e3*this.tweetDuration.value))}toggle(e){this.tweetHold.value!==e&&(e?(this.nodecg.log.info("Tweet is now on hold."),this.tweetShowing.value&&this.durationTimer&&(clearTimeout(this.durationTimer),this.durationTimer=!1)):(this.nodecg.log.info("Tweet is now not on hold."),this.hideTweet()),this.tweetHold.value=e)}processMessage(e){let t=e.data.text,i={};if(d.check(t))return!1;e.includes.users.forEach((t=>{t.id===e.data.author_id&&(i=t)}));const r={avatarUrl:i.profile_image_url,name:i.username,screenName:i.name,createdAt:e.data.created_at,id:e.data.id};e.data.entities?.mentions?.reverse().forEach((e=>{const{start:i,end:r}=e;t=t.substring(0,i)+`<span class="link">${t.substring(i,r+1)}</span>`+t.substring(r+1)})),t=l.default.parse(t),e.data.entities?.urls?.forEach((e=>{t=t.split(e.url).join(`<span class="link">${e.display_url}</span>`)})),e.data.entities?.hashtags?.sort(((e,t)=>t.tag.length-e.tag.length)).forEach((e=>{t="millarstlights"===e.tag.toLowerCase()?t.split(`#${e.tag}`).join(`<span class="link purple">#${e.tag}</span>`):t.split(`#${e.tag}`).join(`<span class="link">#${e.tag}</span>`)}));const n=[];e.includes.media?.forEach((e=>{"photo"===e.type?(n.push(`${e.url}:large`),t=t.split(e.url).join("")):t=t.split(e.url).join(`<span class="link">${e.url}</span>`)})),r.images=n,r.body=(0,u.autop)(t);return this.queue.push((e=>{this.showTweet(r,e)})),this.nodecg.log.debug(`Tweet added to queue at index ${this.queue.length}`),!0}}i.default=e=>{if(!e.bundleConfig||void 0===e.bundleConfig.twitter)return void e.log.error(`"twitter" is not defined in cfg/${e.bundleName}.json! This object contains other properties that are required for the Twitter graphic to function.`);const t=new h(e);e.listenFor("startTweetStream",(()=>t.start())),e.listenFor("stopTweetStream",(()=>t.stop())),e.listenFor("pauseTweetStream",(()=>t.pause())),e.listenFor("resumeTweetStream",(()=>t.resume())),e.listenFor("holdTweetToggle",(e=>t.toggle(e)))}},{"@parcel/transformer-js/src/esmodule-helpers.js":"di8yw"}],di8yw:[function(e,t,i){i.interopDefault=function(e){return e&&e.__esModule?e:{default:e}},i.defineInteropFlag=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.exportAll=function(e,t){return Object.keys(e).forEach((function(i){"default"===i||"__esModule"===i||t.hasOwnProperty(i)||Object.defineProperty(t,i,{enumerable:!0,get:function(){return e[i]}})})),t},i.export=function(e,t,i){Object.defineProperty(e,t,{enumerable:!0,get:i})}},{}],"1VBCz":[function(e,t,i){e("@parcel/transformer-js/src/esmodule-helpers.js").defineInteropFlag(i),i.default=e=>{const t=e.Replicant("nowPlayingPaused",{defaultValue:!1,persistent:!1}),i=e.Replicant("nowPlayingShowing",{defaultValue:!1,persistent:!1}),r=e.Replicant("nowPlaying",{defaultValue:{artUrl:"",title:"",artist:"",album:""},persistent:!1}),n=e.Replicant("assets:albumart",{defaultValue:[],persistent:!1});let a;e.listenFor("toggleNowPlaying",(i=>{t.value!==i&&(i?e.log.info("NowPlaying is now paused."):e.log.info("NowPlaying has now resumed."),t.value=i)})),e.listenFor("nowPlaying",(s=>{const o=n.value.filter((e=>e.name===s.album.toLowerCase().replaceAll(" ","_")));let l="";o.length&&(e.log.debug(`Found image for ${s.album}.`),l=o[0].url),r.value={...s,artUrl:l},i.value&&(clearTimeout(a),i.value=!1),i.value||t.value||(i.value=!0,a=setTimeout((()=>{i.value=!1}),12e3))}))}},{"@parcel/transformer-js/src/esmodule-helpers.js":"di8yw"}]},["2yoZy"],"2yoZy");
//# sourceMappingURL=index.js.map
